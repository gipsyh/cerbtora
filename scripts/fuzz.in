#!/usr/bin/env bash
FAILURES=10 # number of failures before exit
bin="$(cd -- "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd -P)"
random="$bin/random"
for i in random; do
    [ ! -x "${!i}" ] && echo "$(basename "$0"): missing executable $i (${!i})" >&2 && exit 1
    "${!i}" >/dev/null || exit
done
[ $# -lt 1 ] && echo "usage: $(basename "$0") <model checker> [--count=<n>] [<model checker args>]" && exit 0
MC=$(realpath $1)
shift
COUNT=-1
MC_ARGS=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --count=*)
            COUNT="${1#*=}"
            shift
            ;;
        *)
            MC_ARGS="$MC_ARGS $1"
            shift
            ;;
    esac
done
if [ -n "$CERBTORA_WORKDIR" ]; then
    TMP="$CERBTORA_WORKDIR"
    mkdir -p "$TMP"
    trap 'exit' EXIT HUP INT QUIT TERM
else
    mkdir -p ${TMPDIR:-/tmp}/froleyks-cerbtora
    TMP=$(mktemp -d "${TMPDIR:-/tmp}"/froleyks-cerbtora/$(basename "$0")-XXXXXXXX)
    trap 'rm -rf ${TMP}; exit' EXIT HUP INT QUIT TERM
fi

log="$TMP/log"
out="$TMP/out"
# echo $(basename "$0") logging to "$log"
i=0
safe=0
unsafe=0
tout=0
failed=0
total_runs=0
while true; do
    if [ "$COUNT" -ge 0 ] && [ "$total_runs" -ge "$COUNT" ]; then
        echo fuzzed: $i $safe $unsafe $tout $failed >>"$log"
        exit 0
    fi
    "$random" "$MC" $MC_ARGS >"$out"
    res=$?
    ((total_runs += 1))
    if [ $res -eq 0 ]; then
        if grep -q 'check_unsat: Certificate check passed.' "$out"; then
            ((safe += 1))
        elif grep -q 'check_sat: Trace simulation passed' "$out"; then
            ((unsafe += 1))
        elif grep -q 'certified: model checker timeout' "$out"; then
            ((tout += 1))
        else
            echo "$(basename "$0"): ERROR in fuzzing setup"
            exit 1
        fi
        (((i += 1) % 10)) || echo fuzzed: $i $safe $unsafe $tout $failed >>"$log"
        continue
    fi
    cat "$out"
    (((failed += 1) >= FAILURES)) && echo fuzzed: $i $safe $unsafe $tout $failed >>"$log" && exit 0
done
