#!/usr/bin/env bash
bin="$(cd -- "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd -P)"
check_unsat="$bin"/check_unsat
check_sat="$bin"/check_sat
for i in check_unsat check_sat ; do
    [ ! -x "${!i}" ] && echo "$(basename "$0"): missing executable $i (${!i})" >&2 && exit 1
    "${!i}" >/dev/null || exit
done
[ $# -lt 2 ] && echo "usage: $(basename "$0") <model checker> <model> [--mc_time=<limit>] [<model checker args>]" && exit 0
mkdir -p ${TMPDIR:-/tmp}/froleyks-cerbtora
TMP=$(mktemp -d "${TMPDIR:-/tmp}"/froleyks-cerbtora/$(basename "$0")-XXXXXXXX)
trap 'rm -rf "${TMP}"; exit' EXIT HUP INT QUIT TERM
if [[ $1 =~ --mc_time=([0-9]+) ]]; then
    limit="timeout --foreground ${BASH_REMATCH[1]} "
    shift 1
fi

MC="$1"
MODEL="$2"
shift 2
NAME=$(basename "$MODEL" | sed 's/\.[^.]*$//')
CERTIFICATE=$TMP/${NAME}.cert
echo $(basename "$0"): writing witness to "$CERTIFICATE"
LOG=$TMP/${NAME}.log

echo $(basename "$0"): running "$MC" on "$MODEL"
$limit $MC "$MODEL" "$CERTIFICATE" "$@" | tee "$LOG"
res=${PIPESTATUS[0]}
echo $(basename "$0"): model checker exit code $res
[ $res -eq 124 ] && echo $(basename "$0"): model checker timeout && exit 0

if grep -qi "^sat$" "$LOG"; then
    echo $(basename "$0"): Checking SAT
    "$check_sat" "$MODEL" "$CERTIFICATE"
    res=$?
elif grep -qi "^unsat$" "$LOG"; then
    echo $(basename "$0"): Checking UNSAT
    "$check_unsat" $SEQUENTIAL "$MODEL" "$CERTIFICATE"
    res=$?
else
    echo $(basename "$0"): Model checker did not produce a recognizable result
    exit 1
fi
exit $res
