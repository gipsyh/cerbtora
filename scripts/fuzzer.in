#!/usr/bin/env bash
bin="$(cd -- "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd -P)"
BUGS="$bin/../bugs"
fuzz="$bin/fuzz"
certified="$bin/certified"
status="$bin/status"
for i in fuzz certified status; do
  [ ! -x "${!i}" ] && echo "$(basename "$0"): missing executable $i (${!i})" >&2 && exit 1
done
"$fuzz" >/dev/null || exit
[ $# -lt 1 ] && echo "usage: $(basename "$0") <model checker> [--cores=<n>] [--count=<n>] [<model checker args>]" && exit 0

mkdir -p ${TMPDIR:-/tmp}/froleyks-cerbtora
TMP_FUZZER=$(mktemp -d "${TMPDIR:-/tmp}"/froleyks-cerbtora/fuzzer-XXXXXXXX)

cleanup() {
  echo
  jobs -rp | xargs -r kill
  wait
  if [ -d "$BUGS" ] && ls "$BUGS"/bug-*.btor2 >/dev/null 2>&1; then
    echo -e "\n$(basename "$0"): $(basename $MC) on shortes bug\n"
    short=$(wc -l "$BUGS"/bug-*.btor2 | sort -n | head -n 1 | awk '{print $2}')
    model=$(realpath "$bin"/..)/bug.btor2
    witness=$(realpath "$bin"/..)/witness.btor2
    rm -f "$model" "$witness"
    cp "$short" "$model"
    "$certified" "$MC" "$model" "$witness" $MC_ARGS
    echo
    echo $(basename "$0"): "Found a bug of length" $(wc -l "$model" | awk '{print $1}'): $(head -n 1 "$model")
    echo $(basename "$0"): "with witness of length" $(wc -l "$witness" | awk '{print $1}')
    echo $(basename "$0"): "$model"
    echo $(basename "$0"): "$witness"
  fi
  rm -rf "$TMP_FUZZER"
  trap '' EXIT HUP INT QUIT TERM
  exit
}
trap 'cleanup' EXIT HUP INT QUIT TERM
MC=$(realpath $1)
shift
CORES=8
COUNT=-1
MC_ARGS=""
while [[ $# -gt 0 ]]; do
    case $1 in
        --cores=*)
            CORES="${1#*=}"
            shift
            ;;
        --count=*)
            COUNT="${1#*=}"
            shift
            ;;
        *)
            MC_ARGS="$MC_ARGS $1"
            shift
            ;;
    esac
done
echo $(basename "$0"): fuzzing $(basename "$MC") with $CORES thredas
old_bugs=$(ls "$BUGS"/bug-*.btor2 2>/dev/null | wc -l)
if [ "$old_bugs" -gt 0 ] 2>/dev/null; then
  echo $(basename "$0"): "Warning: $old_bugs failure inducing inputs from previous runs found"
  echo $(basename "$0"): run rm -r $(realpath $BUGS)
fi
echo

per_core_count=-1
if [ "$COUNT" -gt 0 ]; then
    per_core_count=$(( (COUNT + CORES - 1) / CORES ))
fi

i=0
while [ $i -lt "$CORES" ]; do
  export CERBTORA_WORKDIR="$TMP_FUZZER/fuzz-$i"
  if [ "$per_core_count" -gt 0 ]; then
      "$fuzz" "$MC" --count="$per_core_count" $MC_ARGS &
  else
      "$fuzz" "$MC" $MC_ARGS &
  fi
  fuzzer[${i}]=$!
  ((i += 1))
done
export CERBTORA_WORKDIR="$TMP_FUZZER"
"$status" &
wait "${fuzzer[@]}"
